# Elastic Load Balancing (ELB) Notes

- Forwards traffic to multiple EC2 instances
- Expose one DNS for application, many EC2s
- Handles failures, runs health checks, provide SSL
- High availability
- Separate public traffic and private traffic
- Integrated with loads of AWS services

### Health Checks
- Crucial for load balancers
- Done on a port and a route, /health endpoint is common
- If no 200, than not healthy

Four types of load balancers
- Classic Load Balancer
  - Deprecated
- Application Load Balancer
  - HTTP, HTTPS, WebSocket
  - Layer 7 HTTP
  - Load balance to multiple application on same machine
  - Support redirects
- Network Load Balancer
  - TCP, TLS, UDP
- Gateway Load Balancer
  - Layer 3 (network layer) IP Protocol

Can restrict EC2 traffic to source from load balancer's security group

### Application Load Balance (v2) (ALB)
- Can route to different target group based on: path of URL, hostname in URL, query string, headers (same domain name)
- Great for microservices, containers
- Port mapping, redirect to dynamic ECS port
- Classic load balancer would need one load balancer per application

What are Target Groups?
- EC2 instances
- ECS tasks
- Lambda functions
- IP addresses

ALB always gets a fixed hostname

Application servers get client IP via X-Forwarded-For and client port via X-Forwarded-Port and proto via X-Forwarded-Proto

### Network Load Balancer (v2) (NLB)
- TCP/UDP
- Can handle millions of requests, extreme performance
- Ultra low latency
- One static IP per AZ, supports elastic IPs
- SO it provides a DNS name AND an IP address, unlike ALB which only provides a DNS name

Target Groups
- EC2 instances
- Private IP addresses
- Application Load Balance (ALB)

Health checks TCP, HTTP and HTTPS

### Gateway Load Balancer (GLB)

- Manage a fleet of 3rd party network virtual appliances in AWS
  - e.g. security appliances that are EC2 instances.
  - Gateway Load Balancer redirects traffic for an application to a fleet of network security appliance
  - Analyse network traffic
  - Operates at Layer 4 - IP packets
  - Transparent Network Gateway
  - For exam, always use GENEVE protocol port 6081

Target Groups
- EC2 instances
- Private IP addresses

### Sticky Sessions / Stickiness / Session Affinity
- Client always redirected to same instance behind load balancer
- Works for CLB, ALB, NLB
- Cookie has expiration data
- Client won't lose session data in instance
- Could bring imbalances in load

Type of cookies
- Application-based Cookies
  - Custom cookie, unique name, can have custom attributes, generated by target application, name specified for each target group
  - Application cookie, generated by ELB, name AWSALBAPP
- Duration-based Cookies
  - Generated by load balancer
  - Name is AWSALB for ALB, AWSELB for CLB

### Cross-Zone Load Balancing
- Each load balancer distributes load evenly across AZs, even to nodes not in the load balancer's AZ
- Without cross-zone, traffic stays in the load balancer's AZ (and load balancer balances traffic within the AZ)
- ALB - enabled by default, no charges for inter AZ data
- NLB/GLB, disabled by default, you pay money for inter AZ data
- CLB, disabled, no charges

### SSL/TLS
- Mainly TLS used nowadays
- Load balancer uses X.509 certificate
- Manage certificates in ACM (AWS Certificate Manager)
- Clients can use SNI (Server Name Indication)
  - Allows multiple SSL certs in one web server
  - Client indicates hostname, so server can find correct certificate
  - Works for ALB/NLB

### Deregistration Delay
- Allows in-flight requests to draining instances, but no new requests to draining/de-registering instance
- Delay of between 1 to 3600, or disable by setting to 0
- Trade off is how quickly you want instances de-registered, vs. how long to allow in-flight requests to complete

