# Amazon S3 Notes

- Main building blocks of AWS
- Advertised as "infinitely scaling"

## Use Cases

- Backup, storage
- Disaster recovery
- Archive
- Hybrid cloud storage
- App hosting
- Media hosting
- Data lakes
- Static website

## Buckets

- Store objects in buckets (directories)
- Globally unique name
- Region specific, though looks global
- Naming convention is lowercase letters, numbers and hyphens

## Objects

- Objects have a key, the full path to object, which can look like directories, but it's just a key in a bucket
- Max size 5TB
- If uploading more than 5GB, must use multi-part upload

## Security

- User-based IAM policies restrict API calls to S3
- Bucket policies - resource-based bucket-wide policies, most common
- Object Access Control List (ACL) - fine grain
- Bucket Access Control List (ACL) - less common

### Bucket Policies

- JSON based policies
  - Resource: bucket/object
  - Effect: allow/deny
  - Actions: APIs to control
  - Principal: account/user

### Block Public Access

- Overriding settings to prevent company data leaks
- Will override even if you set public access with bucket policy

## Static Website Hosting

- Can set your bucket to be a static website with a website URL
- Must set bucket to be publicly accessible, in same way as a non-website bucket

## Versioning

- Version files, enabled at bucket level

## Replication

- Cross-Region Replication (CRR)
- Same-Region Replication (SRR)
- Can be replication for buckets across AWS accounts
- Must give IAM permissions
- CRR - Compliance, lower latency, across accounts
- SRR - live replication between prod and test
- When enabled, only new objects are replicated
- S3 Batch Replication - optionally replicate existing objects
- Can replicate delete markers optionally, but permanent deletions not replicated
- No chaining of replication

## Storage Classes

- General Purpose
  - 99.99% availability
  - Low latency
  - Sustain 2 concurrent facility failures 
  - Use cases: Big Data, gaming and apps, content distribution
- Infrequent Access
  - Lower cost, for data less frequently accessed
  - Standard-Infrequent Access
    - Use cases: Disaster Recovery, backups
  - One Zone-Infrequent Access
    - One AZ, secondary backups
- Glacier classes
  - Glacier Instant Retrieval
    - Millisecond retrieval
    - Minimum storage duration of 90 days
  - Glacier Flexible Retrieval
    - Different options, Bulk 5 to 12 hours is free
    - Minimum storage duration of 90 days
  - Glacier Deep Archive
    - Longer term
    - Minimum storage duration of 180 days
  - Intelligent-Tiering
    - Small monthly fee, objects move automatically between tiers based on usage
- S3 Express One Zone
  - High Performance, single Availability Zone
  - Compute and Storage in same AZ, optimise performance
  - Use cases: latency/data-sensitive apps, AI/ML training

### Move between Storage Classes

- Down from Standard

### Lifecycle rules

- Transition Actions - move X time after creation
- Expiration Actions - delete after X days
- S3 Analytics - recommends for Standard or Standard IA what lifecycle rules you should have for transitioning

## Requester Pays

- Requester pays instead of bucket owner - owner stills pays storage cost, but requester pays networking cost
- Must be user within AWS (not anonymous)

## Event Notifications

- S3:ObjectCreated, S3:Replication, etc.
- Can use name filtering like *.jpg
- E.g. generate thumbnails of image uploaded to S3
- S3 can push to SNS "publish", SQS "send message", Lambda "invoke function"
- Use IAM policies to allow S3 to do that

### Amazon EventBridge

- Can send event to lots of AWS services
- Advanced filtering options
- Multiple destinations at once

## S3 Performance 

- 3,500 PUT/COPY/POST/DELETE request or 5,500 GET/HEAD requests per second per prefix per bucket
- (prefix is same as directories in buckets)
- No limit to number of prefixes
- Multi-Part Upload, recommended for >100MB, must use for >5GB
  - Can parallel upload of parts of file
- Transfer Acceleration - transfer file to AWS edge location, to forward to S3 bucket
  - Compatible with multi-part upload
  - Edge location can use private AWS network which is faster
- Byte-Range Fetches - request specific byte range of file, can parallelize request with these ranges, or request only part of file faster

## Batch Operations

- Bulk operations with single request
- Modify many objects metadata
- Copy many objects
- Encrypt many objects
- Invoke Lambda function on many objects
- Provides extra management and resiliency operations, rather than writing script to do bulk operations on objects
- S3 Inventory to get object list, Athena to query and filter objects

## S3 Storage Lens

- Analyse, optimise storage across AWS organisation
- Discover anamolies, cost efficiencies, data protection best practices
- Aggregate data across org, dashboards, reports
- Default dashboard - common filters and metrics
- Cost-optimization metrics
- Data protection metrics
- Free metrics and paid advanced metrics

## S3 Object Encryption

4 methods of encrypting buckets (on exam)

1. Server-Side Encryption (SSE)
  a. with S3 Managed Keys (SSE-S3)
  b. with KMS Keys in AWS KMS (SSE-KMS)
  c. with customer-provided keys (SSE-C)
2. Client-Side Encryption

Another method is DSSE-KMS, which is double encryption with KMS, but not on exam

### SSE-S3

- Keys managed/owned by AWS
- Encryption type AES-256
- Enabled by default

### SSE-KMS

- User control and audit key usage using CloudTrail
- Limitation, impacted by KMS quota per second (5500/10000/30000 req/s based on region)

### SSE-C

- Customer key from outside of AWS, not stored by AWS
- Must use HTTPS
- Provide key in HTTP headers

### Client-Side Encryption

- Client encrypts data before sending to S3
- Fully managed by customer

## Encryption in transit

- Also called SSL/TLS
- HTTPS is encryption in flight
- You can force HTTPS using bucket policy `"aws:SecureTransport": "false"`

## Default Encryption

- Default encryption is SSE-S3
- Can force encryption with bucket policies

## Cross-Origin Resource Sharing (CORS)

- Allow/deny request from other origins (protocol and domain and port)
- If cross-origin request to S3, must enable CORS headers

## MFA Delete

- Can require users to do MFA before permanently deleting object version, or suspend versioning
- Can only use MFA Delete if versioning is enabled
- Can only be enabled/disabled by root account

## S3 Access Logs

- Logs all access to S3 bucket
- Must be in same region
- Logging bucket used to log a target bucket
- Don't log the log bucket - will create a loop

## Pre-Signed URLs
- Up to 720 mins from console, 168 hours from CLI
- Pre-signed URL can allow someone to inherit permissions of user the generated the URL
- Use cases: allow premium downloads, generate URLs dynamically for everchanging users, allow user to temporarily upload to a location

## S3 GlacierVault Lock

- WORM (Write Once Read Many)
- To do this, create Vault Lock Policy on Glacier
- Lock the policy itself so it can't be deleted

## S3 Object Lock

- Similar for bucket objects, must have versioning enabled
- Retention modes
  - Compliance mode: no users can delete
  - Governance mode: some users have special permission to change retention or delete files
- Retention period: protection for specified time that can be extended
- Legal Hold: protect indefinitely, using IAM permission

## S3 Access Points

- Can have different read/write policies to different prefixes for different user groups within S3 bucket, e.g. /finance, /sales, different user groups can access them
- Simplifies security management
- Has its own DNA name and access point policy
- Can be VPC origin only accessible from private VPC endpoint

## S3 Object Lambda

- Use Lamda Functions to modify object before retrieval
- Lambda Function accesses S3 via a access point, and then the output of the lambda has a "S3 Object Lambda Access Point", for applications to access output
- Could "enrich" data from other sources, no limits to the Lambda function
- Use cases: could redact data, do format conversions, watermarking specific to the user